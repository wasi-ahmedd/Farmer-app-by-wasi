<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farmer Dashboard - FarmerApp</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

  <header class="main-header">
    <h1>üë®‚Äçüåæ Farmer Dashboard</h1>
    <p>Add your crop details and manage your plans.</p>
  </header>

  <main class="home-container">

    <section class="add-plan">
      <h2>Add Crop Plan</h2>
      <form id="planForm">
<select name="crop" id="cropDropdown" required>
  <option value="">-- Select Crop --</option>
</select>

<script>
fetch("assets/data/indian_vegetables.json")
  .then(res => res.json())
  .then(data => {
    const dropdown = document.getElementById("cropDropdown");
    const veggies = data.vegetables;

    // Define emoji for each category üåæ
    const emojiMap = {
      "Leafy Vegetables": "ü•¨",
      "Fruit Vegetables": "üçÖ",
      "Root and Tuber Vegetables": "ü•ï",
      "Leguminous Vegetables": "üå±",
      "Other Seasonal Vegetables": "üçÜ"
    };

    // Loop through each category
    Object.keys(veggies).forEach(category => {
      const optGroup = document.createElement("optgroup");
      optGroup.label = `${emojiMap[category] || "ü•¶"} ${category}`;

      veggies[category].forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        optGroup.appendChild(opt);
      });

      dropdown.appendChild(optGroup);
    });
  });
</script>

  <input type="number" name="quantity" placeholder="Quantity (kg)" required>
  <style>
/* Remove default date hint (mm/dd/yyyy) and show custom placeholder */
input[type="date"] {
  position: relative;
  color: transparent;
}

input[type="date"]::before {
  content: attr(placeholder);
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af; /* light gray */
  pointer-events: none;
}

input[type="date"]:focus,
input[type="date"]:valid {
  color: #000; /* show real date once selected */
}

input[type="date"]:focus::before,
input[type="date"]:valid::before {
  content: "";
}
</style>

<input 
  type="date" 
  name="sow_date" 
  id="sow_date" 
  required 
  placeholder="Sowing Date (MM/DD/YYYY)" 
  pattern="\d{4}-\d{2}-\d{2}" 
  title="Format: YYYY-MM-DD">

<input 
  type="date" 
  name="harvest_date" 
  id="harvest_date" 
  required 
  placeholder="Harvest Date (MM/DD/YYYY)" 
  pattern="\d{4}-\d{2}-\d{2}" 
  title="Format: YYYY-MM-DD">

  <!-- üåç Dynamic location dropdowns -->
  
  <select name="state" id="state" required>
    <option value="">Select State</option>
  </select>

 
  <select name="district" id="district" required>
    <option value="">Select District</option>
  </select>

  <!-- Optional fields for future Taluk & Village -->
  <input type="text" name="taluk" id="taluk" placeholder="Taluk (optional)">
  <input type="text" name="village" id="village" placeholder="Village (optional)">

  <button type="submit" class="btn">Save Plan</button>
</form>

<div id="planMsg"></div>

    </section>

    <section class="my-plans">
      <h2>My Crop Plans</h2>
      <table class="data-table">
        <thead>
          <tr>
            <th>Crop</th>
            <th>Quantity (kg)</th>
            <th>Sow Date</th>
            <th>Harvest Date</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody id="myPlansTable">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </section>

  </main>

  <footer>
    <a href="index.html" class="back-link">‚¨Ö Back to Home</a>
  </footer>

  <script type="module" src="assets/js/plan.js"></script>
  <script type="module">
  async function loadStateDistrictDropdown() {
    const stateSelect = document.getElementById("state");
    const districtSelect = document.getElementById("district");

    const res = await fetch("assets/data/india_states_districts.json");
    const data = await res.json();

    // Load all states
    data.states.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.state;
      opt.textContent = s.state;
      stateSelect.appendChild(opt);
    });

    // When state changes, load districts
    stateSelect.addEventListener("change", () => {
      districtSelect.innerHTML = "<option value=''>Select District</option>";
      const selected = data.states.find(st => st.state === stateSelect.value);
      if (selected) {
        selected.districts.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          districtSelect.appendChild(opt);
        });
      }
    });
  }

  loadStateDistrictDropdown();

  // ‚úÖ Handle form submit
  document.getElementById("planForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());

    try {
      const res = await fetch("http://127.0.0.1:5000/api/farmer/plan", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(formData)
      });

      if (!res.ok) throw new Error("Failed to save plan");

      document.getElementById("planMsg").innerHTML = `<p style="color:green;">‚úÖ Plan saved successfully!</p>`;
      e.target.reset();
    } catch (err) {
      document.getElementById("planMsg").innerHTML = `<p style="color:red;">‚ùå ${err.message}</p>`;
    }
  });
</script>

</body>
</html>
