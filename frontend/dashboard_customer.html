<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Dashboard - FarmerApp</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

  <header class="main-header">
    <h1>ğŸ§‘â€ğŸ¤â€ğŸ§‘ Customer Dashboard</h1>
    <p>Find crops directly from farmers without middlemen.</p>
  </header>

  <main class="home-container">

    <section class="search-section">
      <!-- ğŸŒ¾ Crop Dropdown -->
      <select id="cropDropdown">
        <option value="">-- Select Crop --</option>
      </select>

      <!-- ğŸŒ Location Filters -->
      <select id="state">
        <option value="">Select State</option>
      </select>
      <select id="district">
        <option value="">Select District</option>
      </select>

      <!-- ğŸ“… Harvest Date Filter -->
      <input id="harvestDate" type="date" placeholder="Harvest Date (YYYY-MM-DD)">
      <button id="searchBtn" class="btn">Search</button>
    </section>

    <section class="results-section">
      <h2>Available Crops</h2>
      <div id="resultsContainer" class="recent-crops">
        <p>Search to see crops...</p>
      </div>
    </section>

  </main>

  <footer>
    <a href="index.html" class="back-link">â¬… Back to Home</a>
  </footer>

  <script type="module">
    // âœ… Load Crop Dropdown (Grouped by Category)
    fetch("assets/data/indian_vegetables.json")
      .then(res => res.json())
      .then(data => {
        const dropdown = document.getElementById("cropDropdown");
        const veggies = data.vegetables;
        const emojiMap = {
          "Leafy Vegetables": "ğŸ¥¬",
          "Fruit Vegetables": "ğŸ…",
          "Root and Tuber Vegetables": "ğŸ¥•",
          "Leguminous Vegetables": "ğŸŒ±",
          "Other Seasonal Vegetables": "ğŸ†"
        };

        Object.keys(veggies).forEach(category => {
          const group = document.createElement("optgroup");
          group.label = `${emojiMap[category] || "ğŸ¥¦"} ${category}`;
          veggies[category].forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            group.appendChild(opt);
          });
          dropdown.appendChild(group);
        });
      });

    // âœ… Load State + District Dropdown
    async function loadStateDistrictDropdown() {
      const stateSelect = document.getElementById("state");
      const districtSelect = document.getElementById("district");

      const res = await fetch("assets/data/india_states_districts.json");
      const data = await res.json();

      data.states.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.state;
        opt.textContent = s.state;
        stateSelect.appendChild(opt);
      });

      stateSelect.addEventListener("change", () => {
        districtSelect.innerHTML = "<option value=''>Select District</option>";
        const selected = data.states.find(st => st.state === stateSelect.value);
        if (selected) {
          selected.districts.forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            districtSelect.appendChild(opt);
          });
        }
      });
    }
    loadStateDistrictDropdown();

    // âœ… Search Button Click
    document.getElementById("searchBtn").addEventListener("click", searchCrops);

    async function searchCrops() {
      const crop = document.getElementById("cropDropdown").value;
      const state = document.getElementById("state").value;
      const district = document.getElementById("district").value;
      const harvestDate = document.getElementById("harvestDate").value;

      let url = "http://127.0.0.1:5000/api/market/search?";
      if (crop) url += `crop=${encodeURIComponent(crop)}&`;
      if (state) url += `state=${encodeURIComponent(state)}&`;
      if (district) url += `district=${encodeURIComponent(district)}&`;
      if (harvestDate) url += `date=${encodeURIComponent(harvestDate)}&`;

      const res = await fetch(url);
      const crops = await res.json();
      const container = document.getElementById("resultsContainer");

      if (!crops.length) {
        container.innerHTML = "<p>No crops found near that date or filters.</p>";
        return;
      }

      container.innerHTML = crops.map(crop => `
        <div class="crop-card">
          <h3>${crop.crop}</h3>
          <p>ğŸŒ¾ Quantity: ${crop.quantity} kg</p>
          <p>ğŸ“ ${crop.village || "â€”"}, ${crop.district}, ${crop.state}</p>
          <p>ğŸ—“ï¸ Harvest Date: ${crop.harvest_date}</p>
          <p>ğŸ‘¨â€ğŸŒ¾ Farmer: ${crop.farmer?.username || "Unknown"}</p>
          <p>ğŸ“ Contact: ${crop.farmer?.contact || "N/A"}</p>
        </div>
      `).join("");
    }
  </script>
</body>
</html>
